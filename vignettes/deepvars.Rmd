---
title: "Deep VARs"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Deep VARs}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

```{r setup}
rm(list=ls())
library(deepvars)
library(data.table)
```

## Reduced-form VAR 

Recall the functional from of the reduced-form VAR($p$) with $K$ variables and $p$ lags (with $m \in [1,p]$) 

$$
\begin{aligned}
&& y_t&=A_1 y_{t-1} + A_2 y_{t-2} + ... + A_p y_{t-p} + u_t \\
\end{aligned}
$$

where $y_{t-m}$ are $(K \times 1)$ vectors , $A_m$ are $(K \times K)$ matrices of coefficients and $u_t$ is a $(K \times 1)$ vector of residuals. 

## Deep VAR

The deep VAR ...

## A simple benchmark

```{r example-data}
dt = data.table::data.table(deepvars::fredmd)
var_cols = colnames(dt)[2:ncol(dt)]
```

The underlying time series in levels look non-stationary 

```{r after-diff, fig.dim=c(7,4), fig.cap="Time series in differences."}
dt[,(var_cols) := lapply(.SD, function(i) c(0,diff(i))), .SDcols=var_cols]
chart_data = dt
chart_data = data.table::melt(chart_data, id.vars = "date")

ggplot2::ggplot(chart_data) +
  ggplot2::geom_line(ggplot2::aes(y=value, x=date)) +
  ggplot2::facet_wrap(variable ~ ., scales = "free_y") +
  ggplot2::theme_bw() +
  ggplot2::labs(
    x="Date",
    y="Value"
  )
```

Splitting data into a training and test sample ...

```{r}
data <- dt[,-1] # remove date column
train_val_test <- train_val_test_split(data)
train_ds <- train_val_test$train
valid_ds <- train_val_test$val
test_ds <- train_val_test$test
```

Select lag length ...

```{r}
lags <- lag_order(train_ds, max_lag = 36)$p
```

Fit the two models ...

```{r}
# VAR
var_model <- vareg(train_ds, lags = lags)
# Deep VAR
deepvar_model <- deepvareg(train_ds, valid_ds, lags = lags)
```

### In-sample fit

#### Fitted values

```{r}
y <- var_model$y_train
```

```{r, pred-var, fig.dim=c(7,6), fig.cap="Predictions from VAR."}
par(mfrow=c(2,2))
y_hat <- fitted(var_model)
for (i in 1:ncol(y_hat)) {
  plot(y[,i], t="l", ylab=colnames(y)[i], xlab=NA)
  points(y_hat[,i], t="l", col="red")
}
```

```{r, pred-mlstm, fig.dim=c(7,4), fig.cap="Predictions from MLSTM."}
par(mfrow=c(2,2))
y_hat <- fitted(deepvar_model)$one_step_ahead
for (i in 1:ncol(y_hat)) {
  plot(y[,i], t="l", ylab=colnames(y)[i], xlab=NA)
  points(y_hat[,i], t="l", col="red")
}
```

#### Cumulative loss

```{r, cum-loss, fig.dim=c(7,4), fig.cap="Comparison of cumulative loss for the two models.", eval=TRUE}
library(data.table)
cum_loss_var <- data.table(cum_loss(var_model))[,type:="VAR"]
cum_loss_var[,date:=dt$date[1:(nrow(train_ds)-lags)]]
cum_loss_dvar <- data.table(cum_loss(deepvar_model))[,type:="Deep VAR"]
cum_loss_dvar[,date:=dt$date[1:(nrow(train_ds)-lags)]]
dt_plot <- rbind(cum_loss_dvar, cum_loss_var)
dt_plot <- melt(dt_plot, id.vars = c("type", "date"))
ggplot2::ggplot(data=dt_plot, ggplot2::aes(x=date, y=value, colour=type)) +
  ggplot2::geom_line() +
  ggplot2::facet_wrap(~variable, scales = "free_y") +
  ggplot2::scale_color_discrete(name="Model:") +
  ggplot2::labs(
      x="Date",
      y="Squared error"
    )
```

### Out-of-sample fit

#### Validation sample

```{r}
library(data.table)
cum_loss_var <- data.table(cum_loss(var_model, input_ds = valid_ds))[,type:="VAR"]
cum_loss_var[,date:=1:.N]
cum_loss_dvar <- data.table(cum_loss(deepvar_model, input_ds = valid_ds))[,type:="Deep VAR"]
cum_loss_dvar[,date:=1:.N]
dt_plot <- rbind(cum_loss_dvar, cum_loss_var)
dt_plot <- melt(dt_plot, id.vars = c("type", "date"))
ggplot2::ggplot(data=dt_plot, ggplot2::aes(x=date, y=value, colour=type)) +
  ggplot2::geom_line() +
  ggplot2::facet_wrap(~variable, scales = "free_y") +
  ggplot2::scale_color_discrete(name="Model:") +
  ggplot2::labs(
      x="Date",
      y="Squared error"
    )
```

#### Test sample

```{r}
library(data.table)
cum_loss_var <- data.table(cum_loss(var_model, input_ds = test_ds))[,type:="VAR"]
cum_loss_var[,date:=1:.N]
cum_loss_dvar <- data.table(cum_loss(deepvar_model, input_ds = test_ds))[,type:="Deep VAR"]
cum_loss_dvar[,date:=1:.N]
dt_plot <- rbind(cum_loss_dvar, cum_loss_var)
dt_plot <- melt(dt_plot, id.vars = c("type", "date"))
ggplot2::ggplot(data=dt_plot, ggplot2::aes(x=date, y=value, colour=type)) +
  ggplot2::geom_line() +
  ggplot2::facet_wrap(~variable, scales = "free_y") +
  ggplot2::scale_color_discrete(name="Model:") +
  ggplot2::labs(
      x="Date",
      y="Squared error"
    )
```

### h-step ahead forecasts

```{r}
n_ahead <- 6
```


#### Charts

```{r, var-valid, fig.dim=c(7,4), fig.cap="Forecasts from VAR (out-of-training-sample)."}
pred_var <- predict(var_model, n.ahead = n_ahead)
y <- rbind(valid_ds, test_ds)[1:n_ahead,]
plot(pred_var, y = y, history=50)
```

```{r, var-test, fig.dim=c(7,4), fig.cap="Forecasts from VAR."}
input_ds <- prepare_last_as_input(var_model, valid_ds)
pred_var <- predict(var_model, n.ahead = n_ahead, input_ds)
plot(pred_var, y = test_ds[1:n_ahead,], history=50)
```

```{r, fcst-dvar, fig.dim=c(7,4), fig.cap="Forecasts from Deep VAR."}
# Deep VAR
# deepvar_model <- deepvareg(train_ds, valid_ds = valid_ds, lags = lags, n_ahead = min(lags,n_ahead), num_epochs = 200)
pred_dvar <- predict(deepvar_model, n.ahead = n_ahead)
plot(pred_dvar, y = y, history = 50)
```

```{r}
input_ds <- prepare_last_as_input(deepvar_model, valid_ds)
pred_dvar <- predict(deepvar_model, n.ahead = n_ahead, input_ds)
plot(pred_dvar, y = y, history = 50)
```


#### RMSFE 

<!-- In terms of the Root Mean Squared Forecasting Error the Deep VAR is clearly dominating: -->

```{r}
tab_rmsfe <- rbind(
  data.table(value=rmsfe(pred_var, y=y), variable=names(rmsfe(pred_var, y=y)))[,model:="VAR"],
  data.table(value=rmsfe(pred_dvar, y=y), variable=names(rmsfe(pred_dvar, y=y)))[,model:="Deep VAR"]
)
tab_rmsfe <- data.table::dcast(tab_rmsfe, variable ~ model, value.var = "value")
knitr::kable(
  tab_rmsfe, 
  col.names = c("Variable", "DVAR", "VAR"),
  digits = 5
) 
```

#### Correlations

With respect to correlations between forecasts and actual outcomes there is no clear winner. The VAR appear to perform better for unemployment `U`, while the Deep VAR clearly dominates for production `prod`.

```{r}
tab_cor_fcst <- rbind(
  data.table(value=cor_prediction(pred_var, y=y),variable=colnames(data),model="VAR"),
  data.table(value=cor_prediction(pred_dvar, y=y),variable=colnames(data),model="Deep VAR")
)
tab_pred_fcst <- data.table::dcast(tab_cor_fcst, variable ~ model, value.var = "value")
knitr::kable(
  tab_cor_fcst, 
  col.names = c("Variable", "DVAR", "VAR"),
  digits = 5
) 
```


